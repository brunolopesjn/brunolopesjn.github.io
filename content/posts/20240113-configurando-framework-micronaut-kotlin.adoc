---
title: "Configurando o framework Micronaut com Kotlin"
date: 2024-01-13T22:26:59-03:00
draft: true

author: "Bruno Lopes"
categories: [Kotlin]
tags: [Kotlin, Micronaut]
featuredImage: "/img/20240113-configurando-framework-micronaut-kotlin.svg"
featuredImagePreview: "/img/20240113-configurando-framework-micronaut-kotlin.svg"
---

:source-highlighter: rouge

O _Micronaut_ é um _framework full stack Java_ moderno, baseado na máquina virtual _Java_ (do inglês https://pt.wikipedia.org/wiki/M%C3%A1quina_virtual_Java[_Java Virtual Machine_], JVM) e projetado para construir aplicações _JVM_ modulares e que sejam facilmente testáveis. O _framework_ fornece suporte para as linguagens de programação *_Java_*, *_Kotlin_* e *_Groovy_*.

Foi desenvolvido pelas mesmas pessoas que criaram o https://grails.org/[_Grails framework_] e seu desenvolvimento se inspira muito nas lições aprendidas ao longo dos anos pelos desenvolvedores ao construir diversas aplicações, de monolitos a microsserviços, usando https://spring.io/[_Spring_], https://spring.io/projects/spring-boot/[_Spring Boot_] e https://grails.org/[_Grails_].

O _Micronaut_, por padrão, oferece duas formas de criar um projeto:

* Através de uma https://docs.micronaut.io/latest/guide/#buildCLI[ferramenta de CLI];
* Através de uma ferramenta online de criação de projetos, chamada de https://micronaut.io/launch/[_Micronaut Launch_].

Ambas as formas funcionam bem e são ótimas opções para quem gosta de ter um projeto configurado rapidamente.

Particularmente, quando estou estudando uma nova ferramenta, gosto de configurar tudo manualmente. Essa prática me ajuda a entender as partes que compõe a ferramenta de estudo e, consequentemente, os conceitos envolvidos. Pode parecer contraproducente, mas esta é a minha forma de estudar uma nova ferramenta.

{{< admonition type=warning title="Para refletir" open=true >}}
Tenha em mente que *pessoas diferentes aprendem de maneiras diferentes*! A forma como eu aprendo pode até fazer sentido para você, mas não é uma receita universal e infalível.

Esta é a minha forma de aprender e, escrever esse postagem também faz parte do meu aprendizado pois é uma forma de registrar o que eu aprendi durante meus estudos.

{{< /admonition >}}

## Ferramentas utilizadas

No momento que esta postagem está sendo escrita, as seguintes ferramentas estão sendo utilizadas:

* https://www.jetbrains.com/pt-br/idea/download/?section=windows[IntelliJ IDEA Framework 2023.3.2 Communi Edition]
* https://adoptium.net/temurin/releases/?version=17[Temurin OpenJDK 17.0.9 LTS]
* https://docs.gradle.org/current/userguide/gradle_wrapper.html[Gradle Wrapper 8.4]

{{< admonition type=tip title="configurando o Gradle Wrapper" open=true >}}
O _Gradle Wrapper_ é configurado durante o processo de criação de um projeto _Kotlin_ no _IntelliJ IDEA_. Basta escolher o _Gradle_ como *build system* do novo projeto.

{{< /admonition >}}

Também foi utilizada a linguagem de programação _Kotlin v1.9.21_ e o _Micronaut v4.2.3_.

## Criando o projeto no IntelliJ IDEA CE

Com o _IntelliJ IDEA CE_ aberto, clique no botão *New project* e a janela de criação de novos projetos será aberta. Abaixo uma descrição dos campos apresentados na janela que foi aberta:

* *Name*: O nome do projeto;
* *Location*: Diretório em que será criado o projeto;
* *Create Git repository*: Quando marcado, inicializa o Git (equivalente ao executar o comando `git init`) no processo de criação do projeto;
* *Language*: A linguagem de programação que será utilizada no projeto;
* *Build system*: A ferramenta de construção (_build_) que será utilizada no projeto;
* *JDK*: A versão do _Java Development Kit_ que será utilizada no projeto;
* *Gradle DSL*: A _Domain Specific Language_ (DSL) que será utilizada nos arquivos do _Gradle_. Esta opção só estará ativa se em *Build system* a opção *Gradle* estiver selecionada;
* *Add sample code*: Cria o projeto com um código de exemplo;

Se você expandir a opção *Advanced options*, as seguintes opções serão exibidas:

* *Gradle distribution*: Define o modelo de distribuição do _Gradle_ que será utilizado no projeto;
* *Gradle version*: Define qual versão do _Gradle_ será utilizada;
* *GroupId*: Propriedade do _Gradle_ que define o grupo que o projeto pertence. Geralmente utiliza-se o domínio reverso da empresa (e.g. br.com.xpto);
* *ArtifactId*: Propriedade do _Gradle_ que define o nome do projeto.

A imagem abaixo apresenta o formulário de criação de um projeto no _IntelliJ_ com os campos preenchidos com os valores utilizados nesta postagem.

image::/img/2024011301-configurando-framework-micronaut-kotlin.png[Janela de criação de um projeto Kotlin com o IntelliJ IDEA CE utilizado com os valores utilizados nessa postagem]

## Configurando o Gradle

Após a etapa de criação do projeto no _IntelliJ_, o próximo passo é configurar os plugins e ferramentas necessárias no _Gradle_ para termos um projeto _Micronaut_ funcional. A configuração do _Gradle_ ocorrerá em dois arquivos de configuração: o arquivo `gradle.properties` e no arquivo `build.gradle.kts`.

### Arquivo gradle.properties

Primeiramente, vamos adicionar o seguinte conteúdo no arquivo `gradle.properties`:

[source, Properties]
----
kotlin.code.style=official <1>
micronautVersion=4.2.3 <2>
org.gradle.jvmargs=-Xmx4096M <3>
----
<1> O estilo de código do Kotlin a ser utilizado.
<2> Versão do _Micronaut_ que será utilizada no projeto.
<3> Quantidade de memória máxima que será alocada na _heap_ do _Gradle_.


### Arquivo build.gradle.kts

Agora, vamos modificar o arquivo `build.gradle.kts` para adicionar os _plugin_, dependências e as configurações necessárias para configurar _Micronaut_ no projeto. A modificação será abordada em trechos para facilitar a explicação e, ao final, será apresentado o arquivo completo com todas as modificações realizadas.

Iniciaremos modificando a seção *plugins* do arquivo `build.gradle.kts`, substituindo-a com o seguinte conteúdo:

[%linenums, kotlin]
----
plugins {
    id("org.jetbrains.kotlin.jvm") version "1.9.21"
    id("org.jetbrains.kotlin.plugin.allopen") version "1.9.21"
    id("com.google.devtools.ksp") version "1.9.21-1.0.15"
    id("com.github.johnrengelman.shadow") version "8.1.1"
    id("io.micronaut.application") version "4.2.1"
    id("io.micronaut.aot") version "4.2.1"
}

//  Conteúdo posterior omitido
----

No trecho de configuração acima, são configurados um total de seis plugins ao projeto,sendo: 

* A linha *2* configura o https://kotlinlang.org/docs/gradle-configure-project.html[Gradle kotlin Plugin], responsável por permitir construir um projeto _Kotlin_ com o _Gradle_.
* A linha *3* configura o https://kotlinlang.org/docs/all-open-plugin.html[All Open Plugin] do _Kotlin_, responsável por permitir especificar quais classes _Kotlin_ devem estar abertas para herança durante a compilação.
* A linha *4* configura o https://kotlinlang.org/docs/ksp-overview.html[Kotlin Symbol Processing], responsável por realizar o processamento de anotações e geração de código em projetos _Kotlin_
* A linha *5* configura o https://imperceptiblethoughts.com/shadow/[Gradle Shadow Plugin], responsável por adicionar por combinar todas as dependências e recursos do projeto em um único arquivo _Jar_ (_Java Archive_).
* A linha *6* configura o https://micronaut-projects.github.io/micronaut-gradle-plugin/latest/#_the_gradle_plugins[Micronaut Application Plugin], responsável por construir um projeto _Micronaut_ com o _Gradle_.
* A linha *7* configura o https://micronaut-projects.github.io/micronaut-gradle-plugin/latest/#_the_gradle_plugins[Micronaut AoT Plugin], responsável por integrar o _Micronaut AoT_ no projeto para produzir binários otimizados.

Em seguida, vamos modificar a seção *dependencies* do arquivo `build.gradle.kts` com o seguinte conteúdo:

[%linenums, kotlin]
----
//  Conteúdo anterior omitido

dependencies {
    ksp("io.micronaut:micronaut-http-validation:3.9.2")
    ksp("io.micronaut.serde:micronaut-serde-processor:1.5.2")
    implementation("io.micronaut.kotlin:micronaut-kotlin-runtime:3.2.2")
    implementation("io.micronaut.serde:micronaut-serde-jackson:1.5.2")
    implementation("org.jetbrains.kotlin:kotlin-reflect:1.9.21")
    implementation("org.jetbrains.kotlin:kotlin-stdlib:1.9.21")
    compileOnly("io.micronaut:micronaut-http-client:3.8.7")
    runtimeOnly("ch.qos.logback:logback-classic:1.4.12")
    runtimeOnly("com.fasterxml.jackson.module:jackson-module-kotlin:2.14.2")
    testImplementation("io.micronaut:micronaut-http-client:3.8.7")
}

//  Conteúdo posterior omitido
----

No trecho acima, estamos configurando as bibliotecas (dependências) do _Micronaut_ no projeto.

Na linha *4* está sendo declarado o uso da biblioteca https://micronaut-projects.github.io/micronaut-validation/snapshot/guide/[Micronaut Validation]. Essa biblioteca oferece uma solução customizável de validação através de anotações. 

Em seguida, na linha *5*, está sendo declarado o uso da biblioteca https://micronaut-projects.github.io/micronaut-serialization/latest/guide/[Micronaut Serialization Processor]. Ela é responsável por adicionar os processadores de serialização e deserialização de classes _Kotlin_ para _JSON_ e vice versa através de anotações.

Ambas as declarações de bibliotecas das linhas *4* e *5* iniciam com o uso da palavra reservada *ksp*, que foi introduzida pelo _Kotlin Symbol Processing plugin_ configurado na seção *plugins* previamente. Isso faz com que o código dessas bibliotecas será processado ou gerado pelo _KSP_.

Na linha *6* está sendo declarado o uso da biblioteca https://micronaut-projects.github.io/micronaut-kotlin/latest/guide/[Micronaut Kotlin Integration]. Ela é responsável por adicionar o suporte a configuração com _Config4K_ e uma dependência de tempo de execução para o `jackson-module-kotlin`.

Já na linha *7* está sendo declarado o uso da biblioteca https://micronaut-projects.github.io/micronaut-serialization/latest/guide/[Micronaut Serialization] responsável por serializar e deserializar classes _Kotlin_ para _JSON_ e vice versa. Diferente da biblioteca da linha *5* esta contém todo o código necessário para realizar a serialização e deserialização.

Na linha *8* está sendo declarado o uso da biblioteca https://kotlinlang.org/docs/reflection.html[Kotlin Reflection]. Ela é responsável por permitir a https://pt.wikipedia.org/wiki/Introspec%C3%A7%C3%A3o_(computa%C3%A7%C3%A3o)[introspecção] da estrutura do programa em tempo de execução.

Em seguida, na linha *9* está sendo declarado o uso da biblioteca https://kotlinlang.org/docs/whatsnew18.html#updated-jvm-compilation-target[Kotlin StdLib] responsável por permitir que o _Kotlin_ tenha acesso a recursos específicos do _JDK8_.

Vale ressaltar que nas linhas *6*, *7*, *8* e *9* as declarações das bibliotecas iniciam com o uso da palavra reservada *implements*. Ela indica que a biblioteca será utilizada pelo _Gradle_ no processo de construção (_build_) da aplicação.

Na linha *10* está sendo declarado o uso da biblioteca https://docs.micronaut.io/latest/guide/#httpClient[Micronaut HTTP Client] responsável por oferecer um cliente _HTTP_ ao projeto _Micronaut_. Note que a linha começa com a declaração *compileOnly*, indicando que esta biblioteca será utilizada durante o tempo de _compilação_ mas que não será necessária em tempo de _execução_. Caso seja necessário utiliza-la em tempo de execução para, por exemplo, acessar uma _API Rest_ externa, basta mudar a declaração  *compileOnly* para *implements*.

Continuando, na linha *11* está sendo declarado o uso da biblioteca https://logback.qos.ch/[Logback]. Ela é responsável por fornecer um mecanismo de https://pt.wikipedia.org/wiki/Log_de_dados[log de dados] genérico o suficiente para ser utilizado em qualquer tipo de projeto.

Já na linha *12* está sendo a declarado o uso da biblioteca https://github.com/FasterXML/jackson-module-kotlin[Jackson Module Kotlin]. Ela é responsável por fornecer suporte a serialização e deserialização de classes e classes de dados do _Kotlin_ e seu conjunto de anotações é utilizado pela biblioteca _Micronaut Serialization_.

Aqui também vale ressaltar, que as linhas *11* e *12* as declarações das bibliotecas iniciam com o uso da palavra reservada *runtimeOnly*, indicando que essas bibliotecas serão utilizadas apenas no tempo de _execução_ da aplicação e não no tempo de _compilação_.


Por fim, na linha *13*, está sendo declarado a biblioteca https://docs.micronaut.io/latest/guide/#httpClient[Micronaut HTTP Client]. Talvez você tenha notado, mas essa mesma biblioteca foi declarada na linha *10*, com a diferença que aqui, na linha *13* sua declaração está sendo iniciada com a palavra reservada *testImplementation* ao invés de *compileOnly*. ao ser declarada como *testImplementation*, está sendo informado ao _Gradle_ que durante o processo de compilação dos testes automatizados da aplicação essa biblioteca deve ser utilizada.










Após todas as alterações realizadas, o seu arquivo `build.gradle.kts` deve estar assim:

[source, kotlin]
----
plugins {
    id("org.jetbrains.kotlin.jvm") version "1.9.21"
    id("org.jetbrains.kotlin.plugin.allopen") version "1.9.21"
    id("com.google.devtools.ksp") version "1.9.21-1.0.15"
    id("com.github.johnrengelman.shadow") version "8.1.1"
    id("io.micronaut.application") version "4.2.1"
    id("io.micronaut.aot") version "4.2.1"
}

group = "br.dev.profbrunolopes"
version = "1.0-SNAPSHOT"

repositories {
    mavenCentral()
}

dependencies {
    ksp("io.micronaut:micronaut-http-validation:3.9.2")
    ksp("io.micronaut.serde:micronaut-serde-processor:1.5.2")
    implementation("io.micronaut.kotlin:micronaut-kotlin-runtime:3.2.2")
    implementation("io.micronaut.serde:micronaut-serde-jackson:1.5.2")
    implementation("org.jetbrains.kotlin:kotlin-reflect:1.9.21")
    implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.9.21")
    compileOnly("io.micronaut:micronaut-http-client:3.8.7")
    runtimeOnly("ch.qos.logback:logback-classic:1.4.12")
    runtimeOnly("com.fasterxml.jackson.module:jackson-module-kotlin:2.14.2")
    testImplementation("io.micronaut:micronaut-http-client:3.8.7")
}

application {
    mainClass.set("br.dev.profbrunolopes.ApplicationKt")
}

java {
    sourceCompatibility = JavaVersion.toVersion("17")
}

kotlin {
    jvmToolchain(17)
}

micronaut {
    runtime("netty")
    testRuntime("kotest5")
    processing {
        incremental(true)
        annotations("br.dev.profbrunolopes.*")
    }
    aot {
        // Please review carefully the optimizations enabled below
        // Check https://micronaut-projects.github.io/micronaut-aot/latest/guide/ for more details
        optimizeServiceLoading.set(false)
        convertYamlToJava.set(false)
        precomputeOperations.set(true)
        cacheEnvironment.set(true)
        optimizeClassLoading.set(true)
        deduceEnvironment.set(true)
        optimizeNetty.set(true)
    }
}
----
